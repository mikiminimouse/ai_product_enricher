# AI Product Enricher - Руководство по WebUI

## Введение

WebUI — это графический интерфейс на базе Gradio для тестирования, настройки и конфигурирования сервиса обогащения продуктовых данных. Он позволяет:

- Тестировать обогащение товаров в реальном времени
- Настраивать поля для извлечения
- Редактировать промпты (системные и пользовательские)
- Управлять профилями конфигурации

## Быстрый старт

### Запуск WebUI

```bash
# Активация виртуального окружения
source .venv/bin/activate

# Запуск в демо-режиме (без реального обогащения)
python -m src.ai_product_enricher.main_webui

# Запуск с подключением enricher service (рекомендуется)
python -m src.ai_product_enricher.main_webui --with-enricher

# Запуск на определённом порту
python -m src.ai_product_enricher.main_webui --with-enricher --port 7860

# Запуск с публичным доступом через Gradio Share
python -m src.ai_product_enricher.main_webui --with-enricher --share
```

### Запуск в фоновом режиме (production)

```bash
nohup python -m src.ai_product_enricher.main_webui --with-enricher --port 7860 > webui.log 2>&1 &
echo $! > server.pid
```

### Проверка доступности

После запуска WebUI доступен по адресам:
- Локально: `http://localhost:7860`
- Внешний IP: `http://<SERVER_IP>:7860`

---

## Вкладка "Тестирование"

Основная вкладка для тестирования обогащения товаров.

### Элементы интерфейса

| Элемент | Описание |
|---------|----------|
| **Профиль** | Выбор профиля конфигурации (default или кастомный) |
| **Название товара** | Обязательное поле. Название товара для обогащения |
| **Описание** | Опциональное дополнительное описание товара |
| **Страна происхождения** | Определяет маршрутизацию LLM (RU → Cloud.ru, остальные → Z.ai) |
| **Поля для извлечения** | Чекбоксы для выбора полей, которые нужно извлечь |
| **Веб-поиск** | Включить использование веб-поиска (только для Z.ai) |
| **Кнопка "Обогатить"** | Запуск процесса обогащения |

### Результаты

- **Результат обогащения** — JSON с извлечёнными данными
- **Метаданные** — информация о провайдере LLM, времени обработки, использовании кэша
- **Промпты (preview)** — раскрываемая секция с системным и пользовательским промптами

### Пример использования

1. Введите название товара: `Apple iPhone 15 Pro Max 256GB Black Titanium`
2. Выберите страну: `Китай (CN)`
3. Отметьте поля: `manufacturer`, `trademark`, `category`, `description`
4. Включите веб-поиск: ✓
5. Нажмите **"Обогатить"**

**Ожидаемый результат:**

```json
{
  "manufacturer": "Foxconn",
  "trademark": "Apple",
  "category": "Смартфоны",
  "description": "Флагманский смартфон Apple с инновационным титановым корпусом..."
}
```

### Маршрутизация LLM

| Страна | LLM провайдер |
|--------|---------------|
| RU (Россия) | Cloud.ru (GigaChat) |
| CN, US, KR, JP, DE, TW, др. | Z.ai (GLM-4.7) |
| Не указано | Z.ai (GLM-4.7) |

---

## Вкладка "Настройка полей"

Управление полями для извлечения из продуктовых данных.

### Доступные поля по умолчанию

| Имя поля | Отображаемое имя | Тип | Описание |
|----------|-----------------|-----|----------|
| `manufacturer` | Производитель | string | Компания-производитель товара |
| `trademark` | Торговая марка | string | Бренд или торговая марка товара |
| `category` | Категория | string | Товарная категория |
| `model_name` | Модель | string | Название модели или артикул |
| `description` | Описание | string | Краткое описание товара |
| `features` | Характеристики | array | Ключевые особенности товара |
| `specifications` | Тех. характеристики | object | Словарь технических параметров |
| `seo_keywords` | SEO ключевые слова | array | Ключевые слова для поисковой оптимизации |

### Создание кастомного поля

1. Заполните поля редактора:
   - **Имя поля** — уникальный идентификатор (например, `warranty_period`)
   - **Отображаемое имя** — человеко-читаемое название (например, `Срок гарантии`)
   - **Тип данных** — `string`, `array` или `object`
   - **Описание** — что именно извлекать
   - **Подсказки** — инструкции для LLM (по одной на строку)
   - **Примеры** — формат `Input: ... / Output: ...`

2. Нажмите **"Сохранить поле"**

### Формат примеров

```
Input: Гарантия 2 года
Output: 24 месяца

Input: Срок службы - 3 года
Output: 36 месяцев
```

---

## Вкладка "Редактор промптов"

Редактирование Jinja2 шаблонов для системных и пользовательских промптов.

### Типы шаблонов

- **system** — системный промпт, определяющий роль и формат ответа LLM
- **user** — пользовательский промпт с конкретным запросом на обогащение

### Jinja2 синтаксис

#### Доступные переменные

**Системный промпт:**
- `{{ language_name }}` — название языка (Russian)
- `{{ fields }}` — список полей для извлечения
- `{{ field.name }}` — имя поля
- `{{ field.display_name }}` — отображаемое имя
- `{{ field.description }}` — описание поля
- `{{ field.type }}` — тип данных

**Пользовательский промпт:**
- `{{ product_name }}` — название товара
- `{{ product_description }}` — описание товара (опционально)
- `{{ field_names }}` — список имён полей
- `{{ context_data }}` — дополнительный контекст

#### Управляющие конструкции

```jinja2
{% for field in fields %}
### {{ field.display_name }} (`{{ field.name }}`)
{{ field.description }}
{% endfor %}

{% if product_description %}
**Описание**: {{ product_description }}
{% endif %}
```

### Пример системного шаблона

```jinja2
Ты — эксперт по обогащению продуктовых данных.

## Язык ответа
Отвечай на русском языке ({{ language_name }}).

## Поля для извлечения
{% for field in fields %}
### {{ field.display_name }} (`{{ field.name }}`)
{{ field.description }}
Тип: {{ field.type }}
{% endfor %}

## Формат ответа
Верни результат в формате JSON:
```json
{
{% for field in fields %}
  "{{ field.name }}": <{{ field.type }}>{% if not loop.last %},{% endif %}
{% endfor %}
}
```

### Работа с шаблонами

1. Выберите тип шаблона: `system` или `user`
2. Выберите шаблон из списка
3. Нажмите **"Загрузить"** для просмотра содержимого
4. Нажмите **"Preview"** для просмотра отрендеренного результата
5. Отредактируйте шаблон при необходимости
6. Нажмите **"Сохранить"** для сохранения изменений

---

## Вкладка "Профили"

Управление профилями конфигурации для разных сценариев использования.

### Параметры профиля

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| **Имя профиля** | Уникальный идентификатор | `default` |
| **Описание** | Описание профиля | — |
| **Системный промпт** | Имя системного шаблона | `default` |
| **Пользовательский промпт** | Имя пользовательского шаблона | `default` |
| **Temperature** | Креативность LLM (0-1) | `0.3` |
| **Max Tokens** | Максимальное количество токенов | `4000` |
| **Кэширование** | Включить кэширование | `true` |
| **TTL (секунды)** | Время жизни кэша | `3600` |
| **Веб-поиск** | Включить веб-поиск | `true` |
| **Включённые поля** | Список полей для извлечения | все поля |

### Создание нового профиля

1. Введите имя нового профиля в поле "Имя нового профиля"
2. Выберите базовый профиль для копирования настроек
3. Нажмите **"Создать"**
4. Загрузите новый профиль и отредактируйте настройки
5. Нажмите **"Сохранить профиль"**

### Примеры использования профилей

**Профиль для быстрого обогащения:**
- Temperature: 0.1
- Max Tokens: 1000
- Поля: только `manufacturer`, `trademark`, `category`
- Веб-поиск: выключен

**Профиль для детального анализа:**
- Temperature: 0.5
- Max Tokens: 8000
- Поля: все поля
- Веб-поиск: включён

---

## API Доступ

WebUI предоставляет программный доступ через Gradio API.

### Endpoints

| API Name | Описание |
|----------|----------|
| `_enrich_product` | Обогащение продукта |
| `refresh_fields` | Обновление списка полей |
| `_get_template_content` | Получение содержимого шаблона |
| `_preview_template` | Preview шаблона |
| `load_profile_settings` | Загрузка настроек профиля |
| `_create_new_profile` | Создание нового профиля |

### Пример вызова API

```bash
# Получить event_id
EVENT_ID=$(curl -s -X POST "http://localhost:7860/gradio_api/call/_enrich_product" \
  -H "Content-Type: application/json" \
  -d '{"data": ["default", "Apple iPhone 15 Pro", "", "CN", ["manufacturer", "trademark", "category"], true]}' \
  | jq -r '.event_id')

# Получить результат
curl -s -N "http://localhost:7860/gradio_api/call/_enrich_product/$EVENT_ID"
```

---

## Troubleshooting

### Проблема: WebUI не запускается

**Симптом:** Ошибка при запуске, порт занят

**Решение:**
```bash
# Проверить занятость порта
lsof -i :7860

# Убить процесс если нужно
kill -9 <PID>

# Перезапустить
python -m src.ai_product_enricher.main_webui --with-enricher --port 7860
```

### Проблема: Демо-режим вместо реального обогащения

**Симптом:** Сообщение "Enricher service не подключен"

**Решение:** Запустите с флагом `--with-enricher`:
```bash
python -m src.ai_product_enricher.main_webui --with-enricher
```

### Проблема: Ошибка API ключей

**Симптом:** Ошибки при обогащении, связанные с API

**Решение:** Проверьте переменные окружения:
```bash
echo $ZHIPUAI_API_KEY
echo $CLOUDRU_API_KEY
```

### Проблема: Медленное обогащение

**Симптом:** Обогащение занимает более 30 секунд

**Решения:**
1. Уменьшите количество полей для извлечения
2. Отключите веб-поиск
3. Уменьшите Max Tokens в профиле
4. Проверьте стабильность интернет-соединения

### Проблема: WebUI недоступен извне

**Симптом:** Локально работает, по внешнему IP — нет

**Решения:**
1. Проверьте firewall:
   ```bash
   ufw status
   ufw allow 7860/tcp
   ```
2. Убедитесь, что сервер слушает на `0.0.0.0`:
   ```bash
   lsof -i :7860
   # Должно показать: *:7860 (LISTEN)
   ```

---

## Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `ZHIPUAI_API_KEY` | API ключ Z.ai | — |
| `ZHIPUAI_BASE_URL` | Base URL Z.ai | https://api.z.ai/api/coding/paas/v4 |
| `ZHIPUAI_MODEL` | Модель Z.ai | GLM-4.7 |
| `CLOUDRU_API_KEY` | API ключ Cloud.ru | — |
| `CLOUDRU_BASE_URL` | Base URL Cloud.ru | https://foundation-models.api.cloud.ru/v1 |
| `CLOUDRU_MODEL` | Модель Cloud.ru | ai-sage/GigaChat3-10B-A1.8B |

---

## Дополнительная информация

- **REST API документация:** [docs/API_USAGE.md](./API_USAGE.md)
- **Подробное описание API:** [docs/api.md](./api.md)
- **Основной README:** [../README.md](../README.md)
